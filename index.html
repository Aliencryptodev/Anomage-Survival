<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Anoma Survival</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<!-- Retro fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
  :root{
    --ui-bg: rgba(0,0,0,.55);
    --ui-pill:#0b1220;
    --ui-border:#3b4252;
    --gold:#d4af37;
    --gold-dark:#8b6914;
    --title:'Press Start 2P', system-ui, sans-serif;
    --retro:'Pixelify Sans', system-ui, sans-serif;
  }

  html,body{
    height:100%; margin:0; background:#0e0f13; color:#e6ebef;
    font:14px/1.25 var(--retro);
  }

  /* ===== Top/hud (ocultos por la skin) ===== */
  #topbar{position:fixed;left:0;right:0;top:0;padding:8px 10px;display:flex;gap:8px;align-items:center;background:linear-gradient(180deg,rgba(0,0,0,.65),rgba(0,0,0,.2));z-index:6}
  .pill{padding:2px 6px;border:1px solid var(--ui-border);border-radius:999px;background:var(--ui-pill);font:12px var(--retro)}
  .ok{color:#9fef00}
  #hud{position:fixed;top:8px;right:10px;font:13px var(--retro);opacity:.92;text-align:right;z-index:6}
  #hud div{margin-bottom:2px}
  #topbar { display:none !important; }
  #hud    { display:none !important; }

  /* ===== Canvas ===== */
  #viewport{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
  canvas{background:#101014;image-rendering:pixelated;border:3px solid var(--gold-dark)!important;border-radius:0!important;box-shadow:inset 0 0 0 1px var(--gold),0 4px 8px rgba(0,0,0,.6)!important;margin-bottom:100px!important}

  /* ===== Overlay / Start ===== */
  #overlay,#start{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;background:#000;color:#fff;font-weight:700;z-index:10;text-align:center}
  #overlay.show,#start.show{display:flex}
  .btn{
    margin-top:12px;padding:12px 18px;border-radius:8px;border:2px solid var(--gold-dark);
    background:#151515;color:#fff;cursor:pointer;font:12px var(--retro); letter-spacing:.5px;
    box-shadow:0 2px 8px rgba(0,0,0,.6); transition:.15s transform;
  }
  .btn:hover{ transform:translateY(-1px); }
  #warn{position:fixed;bottom:10px;left:10px;right:10px;padding:10px;border:1px dashed #555;border-radius:8px;background:#111c;display:none;z-index:7}
  #warn.show{display:block}
  #toast{
    position:fixed;left:50%;transform:translateX(-50%);bottom:120px;
    background: linear-gradient(135deg, rgba(60,45,30,0.95) 0%, rgba(40,30,20,0.9) 100%);
    border:2px solid var(--gold-dark); padding:8px 12px;border-radius:6px;opacity:0;transition:.2s;
    pointer-events:auto;font:11px var(--retro); color:var(--gold); z-index:7;
    box-shadow: inset 0 1px 0 rgba(139,105,20,.3), 0 2px 8px rgba(0,0,0,.6);
  }
  #toast.show{opacity:1}

  /* ===== Loading overlay (pulido) ===== */
  #loading{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;background:#0e0f13;color:#e6ebef;z-index:9999}
  #loading:not(.show){display:none;}
  #loading h1{
    margin:0 0 6px 0; font: clamp(20px,3.4vw,38px) var(--title); color:#fff; letter-spacing:2px;
    text-shadow:0 2px 0 rgba(0,0,0,.4);
  }
  .loadbar{width:min(560px,82vw); height:10px; background:#1a1510; border:1px solid var(--gold-dark); border-radius:10px; overflow:hidden; box-shadow: inset 0 1px 0 rgba(212,175,55,.25)}
  .loadbar .fill{height:100%; width:0%; background: linear-gradient(90deg,#ff6b35,var(--gold),#4CAF50); transition: width .25s ease;}
  #loadingMsg{opacity:.9; font:12px var(--retro); letter-spacing:.8px}

  /* Pretty controls panel */
  #loadingControls{
    display:grid; grid-template-columns:1fr 1fr; gap:12px 32px;
    padding:14px 18px; border:1px solid var(--gold-dark); border-radius:10px;
    background:linear-gradient(135deg, rgba(60,45,30,.35), rgba(35,28,20,.35));
    font:12px var(--retro); color:#e6ebef; width:min(560px,86vw);
  }
  #loadingControls .col>div{display:flex;align-items:center;gap:10px;margin:6px 0}
  kbd.key{
    min-width:22px;height:22px; padding:0 6px; border:2px solid var(--gold-dark); border-radius:6px;
    display:inline-flex;align-items:center;justify-content:center;background:#151515; box-shadow: inset 0 1px 0 rgba(212,175,55,.25);
    font:11px var(--retro); color:#fff; letter-spacing:.5px;
  }
  .action{opacity:.85}

  /* En m√≥vil ocultamos la tarjeta de ‚Äúcontroles‚Äù del loading */
  @media (pointer:coarse){
    #loadingControls{ display:none !important; }
  }

  /* ===== Start screen (alineado/bonito) ===== */
  #start{background:#0e0f13;color:#e6ebef;font-family:var(--retro)}
  #start h1{font: clamp(22px,3.2vw,36px) var(--title); margin:0 0 8px 0; letter-spacing:2px}
  #start>div{opacity:.95; margin-bottom:20px; letter-spacing:.4px}
  #charSelect{
    display:grid; grid-template-columns:repeat(2,minmax(220px,260px));
    gap:26px; justify-content:center; margin-bottom:16px;
  }
  .char{
    background:#151515; border:2px solid #444; color:#fff; border-radius:10px; cursor:pointer;
    display:flex; flex-direction:column; align-items:center; gap:12px; padding:18px; transition:.15s transform, .15s border-color, .15s box-shadow;
  }
  .char:hover{ transform: translateY(-2px); border-color:#aaa }
  .char.selected{ border:2px solid #9fef00; background:#1a1a1a; box-shadow:0 0 10px rgba(159,239,0,0.28) }
  /* Retrato sin borde gris; √∫nico marco dorado en el canvas */
  .portrait{
    width:128px; height:128px; display:grid; place-items:center; background:#0f0f0f;
    border:none; border-radius:8px; box-shadow: inset 0 0 0 1px #222;
  }
  #charSelect .char canvas{
    width:96px; height:96px; image-rendering:pixelated; background:transparent;
    border:3px solid var(--gold); border-radius:6px;
    box-shadow:0 0 0 2px #2a2317 inset, 0 6px 18px rgba(212,175,55,.28);
  }
  .char-name{font:12px var(--retro); letter-spacing:.6px; opacity:.9}
  #chosen{font:13px var(--retro); margin-top:4px; color:#e6ebef}
  #chosenName{color:#9fef00}

  #btnStart{
    padding:14px 28px; border:2px solid var(--gold-dark); border-radius:10px;
    background: linear-gradient(135deg, #4CAF50, #45a049);
    color:#fff; font:12px var(--retro); letter-spacing:.8px; cursor:pointer;
  }
  #btnStart.ready{ animation:pulse 2s infinite }
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(76,175,80,.7)}70%{box-shadow:0 0 0 14px rgba(76,175,80,0)}100%{box-shadow:0 0 0 0 rgba(76,175,80,0)}}

  /* ===== Bottom ‚ÄúDiablo‚Äù UI ===== */
  #gameUI{
    position:fixed; bottom:0; left:0; right:0; height:100px;
    background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(20,15,10,0.3) 20%, rgba(40,30,20,0.8) 50%, rgba(60,45,30,0.95) 100%);
    z-index:1000; pointer-events:auto; font-family:var(--retro)
  }
  #healthOrb,#manaOrb{
    position:absolute; bottom:10px; width:80px; height:80px; border-radius:50%;
    border:3px solid var(--gold-dark); box-shadow: inset 0 0 20px rgba(0,0,0,.5), 0 0 15px rgba(139,105,20,.6); overflow:hidden; cursor:pointer;
  }
  #healthOrb{left:20px;background: radial-gradient(circle at 30% 30%, rgba(255,100,100,1) 0%, rgba(200,50,50,1) 40%, rgba(150,0,0,1) 80%, rgba(100,0,0,1) 100%)}
  #manaOrb{right:20px;background: radial-gradient(circle at 30% 30%, rgba(100,150,255,1) 0%, rgba(50,100,200,1) 40%, rgba(0,50,150,1) 80%, rgba(0,25,100,1) 100%)}
  #healthOrbFill,#manaOrbFill{position:absolute; bottom:0; left:0; right:0; transition:height .3s ease; border-radius:0 0 50px 50px}
  #healthOrbFill{background: linear-gradient(to top,#cc2936 0%,#ff4444 30%,#ff6666 70%,#ffaaaa 100%)}
  #manaOrbFill{background: linear-gradient(to top,#4169e1 0%,#6495ed 30%,#87ceeb 70%,#b0e0e6 100%)}
  #healthText,#manaText{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#fff; font:700 10px var(--retro); text-shadow:1px 1px 2px rgba(0,0,0,.8); z-index:2}

  #skillPanel{
    position:absolute; bottom:15px; left:50%; transform:translateX(-50%);
    background: linear-gradient(135deg, rgba(60,45,30,0.95) 0%, rgba(40,30,20,0.9) 100%);
    border:2px solid var(--gold-dark); border-radius:8px; padding:8px 12px; display:flex; gap:8px; align-items:center;
    box-shadow: inset 0 1px 0 rgba(139,105,20,.3), 0 2px 8px rgba(0,0,0,.6);
    font-family:var(--retro)
  }
  .skill-slot{width:50px; height:50px; background: linear-gradient(135deg, rgba(40,30,20,1) 0%, rgba(20,15,10,1) 100%); border:1px solid var(--gold-dark); border-radius:6px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:.2s; position:relative}
  .skill-slot:hover{ border-color:var(--gold); box-shadow:0 0 8px rgba(212,175,55,.4) }
  .skill-slot.active{ background: linear-gradient(135deg, rgba(212,175,55,.25) 0%, rgba(139,105,20,.15) 100%); border-color:var(--gold); box-shadow: inset 0 0 8px rgba(212,175,55,.25), 0 0 12px rgba(212,175,55,.45) }
  .skill-icon{ width:36px; height:36px; image-rendering:pixelated }
  .skill-key{position:absolute; top:-6px; right:-6px; background:var(--gold-dark); color:var(--gold); font:700 9px var(--retro); width:14px; height:14px; border-radius:50%; display:flex; align-items:center; justify-content:center; border:1px solid var(--gold)}
  .skill-level{position:absolute; bottom:-6px; left:50%; transform:translateX(-50%); background:#cc2936; color:#fff; font:700 9px var(--retro); padding:1px 4px; border-radius:8px; border:1px solid var(--gold-dark); min-width:12px; text-align:center}
  #gameInfo{margin-left:12px; padding-left:12px; border-left:1px solid var(--gold-dark); color:var(--gold); font:9px var(--retro)}
  .info-line{margin-bottom:2px; display:flex; gap:6px}
  .info-label{color:#c4a484}
  .info-value{color:var(--gold); font-weight:700}
  .info-value.red{color:#ff4444} .info-value.green{color:#88ff88} .info-value.yellow{color:#ffdd44}

  /* Responsive m√≠nimos del HUD */
  @media (max-width: 768px){
    #gameUI{height:80px}
    #healthOrb,#manaOrb{width:60px;height:60px;bottom:8px}
    #healthOrb{left:15px} #manaOrb{right:15px}
    #skillPanel{bottom:12px;padding:6px 8px}
    .skill-slot{width:28px;height:28px} .skill-icon{width:24px;height:24px}
    #gameInfo{font-size:8px}
    canvas{margin-bottom:80px!important}
    #charSelect{grid-template-columns:repeat(2,minmax(160px,200px)); gap:18px}
    .portrait{width:112px;height:112px}
  }

  /* ===== Controles m√≥viles (dos joysticks + RUN) ===== */
  #mobileControls{ position:fixed; inset:0; pointer-events:none; z-index:1200; display:none; }
  @media (pointer:coarse){ #mobileControls{ display:block; } }

  /* oculta controles m√≥viles cuando est√° visible loading o start */
  #loading.show ~ #mobileControls,
  #start.show ~ #mobileControls { display:none !important; }

  .joy-base{
    position:absolute; width:132px; height:132px; border-radius:50%;
    background:#0008; border:2px solid var(--gold-dark);
    box-shadow:0 0 10px #000, inset 0 0 0 1px rgba(212,175,55,.25);
    pointer-events:auto;
  }
  .joy-hat{
    position:absolute; width:56px; height:56px; border-radius:50%;
    transform:translate(38px,38px);
    background:rgba(212,175,55,.25); border:2px solid var(--gold);
    box-shadow:0 0 0 2px #2a2317 inset, 0 6px 18px rgba(212,175,55,.28);
  }

  /* posiciones por defecto */
  #joyMove { left:18px;  bottom:110px; }
  #joyShoot{ right:18px; bottom:110px; }  /* joystick de disparo ocupa el lugar del antiguo RUN */

  /* bot√≥n RUN encima del joystick derecho */
  #runBtn{
    position:absolute; right:22px; bottom:220px;
    width:84px; height:84px; border-radius:50%; pointer-events:auto;
    background:radial-gradient(circle at 35% 35%, #5fd37a, #2a8b3f 70%, #1a5727);
    border:2px solid var(--gold-dark); box-shadow:0 4px 16px rgba(0,0,0,.45);
    display:flex; align-items:center; justify-content:center; color:#fff; font-family:var(--retro); font-size:12px
  }

  @media (max-width:768px){
    .joy-base{ width:118px; height:118px; }
    .joy-hat { width:50px; height:50px; transform:translate(34px,34px) }
    #runBtn{ right:18px; bottom:200px; width:74px; height:74px; font-size:11px }
  }

  #healthOrb, #manaOrb, #skillPanel { pointer-events:auto; }
</style>
</head>
<body>

  <!-- (ocultos) -->
  <div id="topbar">
    <div class="pill">WASD/‚Üê‚Üí‚Üë‚Üì Move</div>
    <div class="pill">Click shoots ‚Äî 1üî• 2‚ö° 3‚ùÑ 4üåë</div>
    <div class="pill" id="spritesState">Sprites <span id="progress">loading‚Ä¶</span></div>
  </div>
  <div id="hud">
    <div>Map <span id="biome">1</span> ¬∑ Life <span id="hp">100</span></div>
    <div>Kills <span id="kills">0</span>/50 ¬∑ Boss <span id="boss">‚Äî</span></div>
    <div>Essence <span id="pts">0</span> ¬∑ <span id="wname">Fire</span> Lv <span id="wlv">1</span></div>
  </div>

  <!-- VIEWPORT + CANVAS -->
  <div id="viewport"><canvas id="game" width="960" height="540"></canvas></div>

  <!-- LOADING -->
  <div id="loading" class="show">
    <h1>ANOMA SURVIVAL</h1>
    <div class="loadbar"><div class="fill" id="loadingFill" style="width:0%"></div></div>
    <div id="loadingMsg">LOADING</div>

    <!-- Controles (se ocultan en m√≥vil) -->
    <div id="loadingControls">
      <div class="col">
        <div><kbd class="key">W</kbd><kbd class="key">A</kbd><kbd class="key">S</kbd><kbd class="key">D</kbd> <span class="action">‚Äî MOVE</span></div>
        <div><kbd class="key">CLICK</kbd> <span class="action">‚Äî SHOOT</span></div>
      </div>
      <div class="col">
        <div><kbd class="key">Space</kbd> <span class="action">‚Äî RUN</span></div>
        <div><kbd class="key">1</kbd><kbd class="key">2</kbd><kbd class="key">3</kbd><kbd class="key">4</kbd> <span class="action">‚Äî CHANGE SPELL</span></div>
      </div>
    </div>
  </div>

  <!-- START -->
  <div id="start" class="show">
    <h1>ANOMA SURVIVAL</h1>
    <div>CHOOSE YOUR CHARACTER AND PRESS <b>Play</b></div>

    <div id="charSelect">
      <button class="char" data-hero="anomage">
        <div class="portrait"><canvas id="prev-anomage" width="64" height="64"></canvas></div>
        <div class="char-name">ANOMAGE</div>
      </button>
      <button class="char" data-hero="shrimp">
        <div class="portrait"><canvas id="prev-shrimp" width="64" height="64"></canvas></div>
        <div class="char-name">SHRIMP</div>
      </button>
    </div>

    <div id="chosen">SELECTED: <b id="chosenName">ANOMAGE</b></div>
    <button id="btnStart" class="btn">Play</button>
  </div>

  <!-- Sprites.json loader -->
  <div id="warn">
    <span>No se pudo cargar <b>assets/Sprites.json</b> (CORS en <code>file://</code>). Usando rutas por defecto.</span>
    <button id="btn-pick" class="btn" style="padding:6px 10px;margin-top:0">Cargar Sprites.json‚Ä¶</button>
    <input id="file-pick" type="file" accept="application/json" style="display:none"/>
  </div>

  <div id="toast"></div>

  <!-- Controles m√≥viles (dos joysticks + run) -->
  <div id="mobileControls" aria-hidden="true">
    <div id="joyMove"  class="joy-base"><div class="joy-hat" id="hatMove"></div></div>
    <div id="joyShoot" class="joy-base"><div class="joy-hat" id="hatShoot"></div></div>
    <button id="runBtn" type="button">RUN</button>
  </div>

  <!-- OVERLAY muerte -->
  <div id="overlay">
    <div id="overlay-text" style="font:16px var(--retro);letter-spacing:.5px;"></div>
    <div id="overlay-sub" style="opacity:.9;margin-top:6px;font:12px var(--retro)"></div>
    <button id="overlay-btn" class="btn">Continue</button>
  </div>

  <!-- N√∫cleo + optimizaciones -->
  <script src="game.js"></script>
  <script src="optimization.js"></script>

  <!-- M√ìVIL: pantalla completa + joysticks + run + cambio de spell mientras se mueve -->
  <script>
  (function(){
    const isMobile = matchMedia('(pointer:coarse)').matches || /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);

    // Pantalla completa en el primer toque
    if (isMobile) {
      const reqFS = () => {
        const el = document.documentElement;
        const fn = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
        if (fn) try{ fn.call(el); }catch(_){}
      };
      window.addEventListener('touchend', ()=>reqFS(), { once:true });
    }

    // Helpers
    const cv = document.getElementById('game');
    const joyMove  = document.getElementById('joyMove');
    const hatMove  = document.getElementById('hatMove');
    const joyShoot = document.getElementById('joyShoot');
    const hatShoot = document.getElementById('hatShoot');
    const runBtn   = document.getElementById('runBtn');

    function inRect(el, x, y){ const r=el.getBoundingClientRect(); return x>=r.left && x<=r.right && y>=r.top && y<=r.bottom; }
    function center(el){ const r=el.getBoundingClientRect(); return { x:r.left+r.width/2, y:r.top+r.height/2, r:Math.min(r.width,r.height)/2 }; }

    // Estado joysticks
    const stick = {
      move:  { id:null, cx:0, cy:0, r:0, active:false },
      shoot: { id:null, cx:0, cy:0, r:0, active:false }
    };

    // Acceso seguro al Input
    function $INPUT(){ try { return (window.GAME && window.GAME._inputRef) ? window.GAME._inputRef : window.Input; } catch{return window.Input;} }

    // MOVER
    function setHat(el, dx, dy){
      const lim = (stick.move.r||stick.shoot.r)*0.6 || 40;
      const k = Math.min(1, lim/(Math.hypot(dx,dy)||1));
      const x = dx*k, y = dy*k;
      el.style.transform = `translate(${(el===hatMove?38:38)+x}px, ${(el===hatMove?38:38)+y}px)`;
      return { x, y, lim };
    }
    function moveUpdate(dx,dy){
      const input = $INPUT(); if(!input) return;
      const m = setHat(hatMove, dx, dy);
      input.stick.active = true;
      input.stick.x = (m.x / m.lim);
      input.stick.y = (m.y / m.lim);
    }
    function moveEnd(){
      const input = $INPUT(); if(!input) return;
      input.stick.active=false; input.stick.x=0; input.stick.y=0;
      hatMove.style.transform='translate(38px,38px)';
      stick.move.active=false; stick.move.id=null;
    }

    // DISPARAR: apuntamos alrededor del jugador y mantenemos mouse.down = true mientras est√© activo
    function shootUpdate(dx,dy){
      const G = window.GAME;
      if (!G || !G.player) return;
      const len = Math.hypot(dx,dy)||1;
      const nx=dx/len, ny=dy/len;
      setHat(hatShoot, dx, dy);

      const input = $INPUT(); if(!input) return;
      input.mouse.down = true;
      // apuntamos un poco por delante del jugador:
      const R = 200;
      input.mouse.x = G.player.x + nx*R;
      input.mouse.y = G.player.y + ny*R;
    }
    function shootEnd(){
      const input = $INPUT(); if(!input) return;
      hatShoot.style.transform='translate(38px,38px)';
      input.mouse.down = false;
      stick.shoot.active=false; stick.shoot.id=null;
    }

    // Pointer handlers gen√©ricos
    function startJoy(which, e){
      const base = which==='move' ? joyMove : joyShoot;
      const s = stick[which];
      const c=center(base);
      s.id=e.pointerId; s.cx=c.x; s.cy=c.y; s.r=c.r; s.active=true;
      const dx=e.clientX-c.x, dy=e.clientY-c.y;
      which==='move' ? moveUpdate(dx,dy) : shootUpdate(dx,dy);
    }
    function moveJoy(e){
      if (stick.move.active && e.pointerId===stick.move.id){
        moveUpdate(e.clientX-stick.move.cx, e.clientY-stick.move.cy);
      }
      if (stick.shoot.active && e.pointerId===stick.shoot.id){
        shootUpdate(e.clientX-stick.shoot.cx, e.clientY-stick.shoot.cy);
      }
    }
    function endJoy(e){
      if (e.pointerId===stick.move.id)  moveEnd();
      if (e.pointerId===stick.shoot.id) shootEnd();
    }

    // Bind joysticks
    ;[joyMove,joyShoot].forEach((base,i)=>{
      base.addEventListener('pointerdown', (e)=>{ e.preventDefault(); startJoy(i===0?'move':'shoot', e); });
    });
    window.addEventListener('pointermove', moveJoy);
    window.addEventListener('pointerup', endJoy);
    window.addEventListener('pointercancel', endJoy);

    // RUN (dash)
    if (runBtn){
      runBtn.addEventListener('pointerdown', (e)=>{ e.preventDefault(); const I=$INPUT(); if(I) I.dash=true; });
    }

    // Cambiar hechizo con toque aunque el joystick est√© pulsado
    document.querySelectorAll('.skill-slot').forEach(slot=>{
      slot.addEventListener('touchstart', (ev)=>{
        ev.preventDefault();
        document.querySelectorAll('.skill-slot').forEach(s=>s.classList.remove('active'));
        slot.classList.add('active');
        if (window.GAME) window.GAME.weapon = slot.dataset.skill;
      }, {passive:false});
    });

    // Ocultar controles m√≥viles cuando el START est√° visible (por si el HTML inicial no lleva .show)
    const start = document.getElementById('start');
    const mob   = document.getElementById('mobileControls');
    if (start && mob){
      const sync=()=>{ mob.style.display = (matchMedia('(pointer:coarse)').matches && !start.classList.contains('show')) ? 'block' : 'none'; };
      sync();
      new MutationObserver(sync).observe(start,{attributes:true,attributeFilter:['class']});
    }
  })();
  </script>

  <!-- Diablo-style bottom bar (sin cambios funcionales) -->
  <script>
/* Helpers de estado expuesto */
function $GAME(){ try { return (typeof window!=='undefined' && window.GAME) || (typeof GAME!=='undefined' ? GAME : null); } catch(_) { return null; } }
function $BIOME(){ try { return (typeof window!=='undefined' && typeof window.BIOME!=='undefined') ? window.BIOME : (typeof BIOME!=='undefined' ? BIOME : 0); } catch(_) { return 0; } }
function $BOSS(){ try { return (typeof window!=='undefined' && typeof window.CURRENT_BOSS!=='undefined') ? window.CURRENT_BOSS : (typeof CURRENT_BOSS!=='undefined' ? CURRENT_BOSS : null); } catch(_) { return null; } }

/* Crear barra inferior */
function createDiablo2UI() {
  if (document.getElementById('gameUI')) return;
  const gameUI = document.createElement('div'); gameUI.id = 'gameUI'; document.body.appendChild(gameUI);

  const healthOrb = document.createElement('div');
  healthOrb.id = 'healthOrb';
  healthOrb.innerHTML = `<div id="healthOrbFill" style="height:100%;"></div><div id="healthText">100/100</div>`;
  gameUI.appendChild(healthOrb);

  const manaOrb = document.createElement('div');
  manaOrb.id = 'manaOrb';
  manaOrb.innerHTML = `<div id="manaOrbFill" style="height:100%;"></div><div id="manaText">50/50</div>`;
  gameUI.appendChild(manaOrb);

  const skillPanel = document.createElement('div');
  skillPanel.id = 'skillPanel';
  skillPanel.innerHTML = `
    <div class="skill-slot active" data-skill="fire">
      <img class="skill-icon" src="assets/Sprites/image_spells/fireball_1.png" alt="Fire">
      <div class="skill-key">1</div>
      <div class="skill-level" id="fireLevel">1</div>
    </div>
    <div class="skill-slot" data-skill="light">
      <img class="skill-icon" src="assets/Sprites/image_spells/lightning_1.png" alt="Light">
      <div class="skill-key">2</div>
      <div class="skill-level" id="lightLevel">1</div>
    </div>
    <div class="skill-slot" data-skill="ice">
      <img class="skill-icon" src="assets/Sprites/image_spells/ice_shard_1.png" alt="Ice">
      <div class="skill-key">3</div>
      <div class="skill-level" id="iceLevel">1</div>
    </div>
    <div class="skill-slot" data-skill="dark">
      <img class="skill-icon" src="assets/Sprites/image_spells/dark_blast_1.png" alt="Dark">
      <div class="skill-key">4</div>
      <div class="skill-level" id="darkLevel">1</div>
    </div>
    <div id="gameInfo">
      <div class="info-line"><span class="info-label">Map:</span><span class="info-value" id="mapValue">1</span></div>
      <div class="info-line"><span class="info-label">Kills:</span><span class="info-value" id="killsValue">0</span><span style="color:#666;">/50</span></div>
      <div class="info-line"><span class="info-label">Boss:</span><span class="info-value red" id="bossValue">‚Äî</span></div>
      <div class="info-line"><span class="info-label">Essence:</span><span class="info-value yellow" id="essenceValue">0</span></div>
    </div>
  `;
  gameUI.appendChild(skillPanel);

  // Click para cambiar arma
  document.querySelectorAll('.skill-slot').forEach(slot=>{
    slot.addEventListener('click', ()=>{
      document.querySelectorAll('.skill-slot').forEach(s=>s.classList.remove('active'));
      slot.classList.add('active');
      const G=$GAME(); if(G) G.weapon = slot.dataset.skill;
    });
  });
}

/* Actualizaciones peri√≥dicas de UI */
function updateDiablo2UI() {
  const G = $GAME(); if (!G || !G.player) return;
  const p = G.player;

  const healthFill = document.getElementById('healthOrbFill');
  const healthText = document.getElementById('healthText');
  if (healthFill && healthText) {
    const hpPct = Math.max(0, Math.min(100, (p.hp/p.hpMax)*100));
    healthFill.style.height = `${hpPct}%`;
    healthText.textContent = `${Math.round(p.hp)}/${p.hpMax}`;
  }

  const manaFill = document.getElementById('manaOrbFill');
  const manaText = document.getElementById('manaText');
  if (manaFill && manaText) {
    const mpPct = Math.max(0, Math.min(100, (p.mana/p.manaMax)*100));
    manaFill.style.height = `${mpPct}%`;
    manaText.textContent = `${Math.round(p.mana)}/${p.manaMax}`;
  }

  const mapValue = document.getElementById('mapValue');
  const killsValue = document.getElementById('killsValue');
  const bossValue = document.getElementById('bossValue');
  const essenceValue = document.getElementById('essenceValue');

  if (mapValue) mapValue.textContent = ($BIOME()|0) + 1;
  if (killsValue) killsValue.textContent = G.killed|0;

  const B = $BOSS();
  if (bossValue) {
    if (B) { bossValue.textContent = B.dead ? 'Dead' : 'Alive'; bossValue.className = B.dead ? 'info-value green' : 'info-value red'; }
    else { bossValue.textContent = '‚Äî'; bossValue.className = 'info-value'; }
  }
  if (essenceValue) essenceValue.textContent = G.points|0;

  // Nivel y arma activa
  ['fire','light','ice','dark'].forEach(k=>{
    const el=document.getElementById(k+'Level');
    if (el) el.textContent = (G.upgrades?.[k]||1);
  });
  if (G.weapon) {
    document.querySelectorAll('.skill-slot').forEach(s=>s.classList.toggle('active', s.dataset.skill===G.weapon));
  }
}

/* Teclas r√°pidas 1-4 (arma) */
document.addEventListener('keydown', (e)=>{
  const map = { '1':'fire', '2':'light', '3':'ice', '4':'dark' };
  const G = $GAME();
  if (map[e.key] && G && G.running) { G.weapon = map[e.key]; }
});

/* Init UI robusto: no crear la UI si el start est√° visible */
function ensureUI(){
  const start = document.getElementById('start');
  const startVisible = start && start.classList.contains('show');
  if (!startVisible && !document.getElementById('gameUI')) {
    createDiablo2UI();
  }
}
document.addEventListener('DOMContentLoaded', ensureUI);
window.addEventListener('load', ensureUI);

const startEl = document.getElementById('start');
if (startEl) {
  const obs = new MutationObserver(() => {
    const visible = startEl.classList.contains('show');
    if (!visible) ensureUI();                 // cuando se cierre el start, crea la UI si a√∫n no existe
    const ui = document.getElementById('gameUI');
    if (ui) ui.style.display = visible ? 'none' : ''; // si el start vuelve a mostrarse, oculta la UI ya creada
  });
  obs.observe(startEl, { attributes: true, attributeFilter: ['class'] });
}

/* tick periodic UI */
setInterval(() => { updateDiablo2UI(); }, 100);
  </script>
</body>
</html>
