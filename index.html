<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Anoma Survival</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root { --ui-bg: rgba(0,0,0,.55); --ui-pill:#0b1220; --ui-border:#3b4252; }
  html,body{height:100%;margin:0;background:#0e0f13;color:#e6ebef;font:14px/1.2 system-ui,Segoe UI,Roboto,Arial}
  #topbar{position:fixed;left:0;right:0;top:0;padding:8px 10px;display:flex;gap:8px;align-items:center;background:linear-gradient(180deg,rgba(0,0,0,.65),rgba(0,0,0,.2));z-index:6}
  .pill{padding:2px 6px;border:1px solid var(--ui-border);border-radius:999px;background:var(--ui-pill);font:12px monospace}
  .ok{color:#9fef00}
  #hud{position:fixed;top:8px;right:10px;font:13px monospace;opacity:.92;text-align:right;z-index:6}
  #hud div{margin-bottom:2px}
  #viewport{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
  canvas{background:#101014;image-rendering:pixelated;border:1px solid #1f2630;box-shadow:0 0 0 1px #000}
  #overlay,#start{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;background:#000;color:#fff;font-weight:700;z-index:10;text-align:center}
  #start h1 {
  font-size: 48px !important; 
  margin: 0 0 20px 0 !important;
  letter-spacing: 2px;
}

#start > div {
  font-size: 18px !important;
  margin-bottom: 30px !important;
}

#charSelect {
  gap: 40px !important;
  margin-bottom: 30px !important;
}

#charSelect .char {
  padding: 20px 24px !important;
  font-size: 18px !important;
  gap: 12px !important;
}

#charSelect canvas {
  width: 96px !important;
  height: 96px !important;
  border: 2px solid #444 !important;
}

#chosen {
  font-size: 20px !important;
  margin-bottom: 20px !important;
}

#btnStart {
  padding: 16px 32px !important;
  font-size: 18px !important;
}
  #overlay.show,#start.show{display:flex}
  .btn{margin-top:12px;padding:10px 14px;border-radius:8px;border:1px solid #888;background:#151515;color:#fff;cursor:pointer;font:14px/1 monospace}
  #warn{position:fixed;bottom:10px;left:10px;right:10px;padding:10px;border:1px dashed #555;border-radius:8px;background:#111c;display:none;z-index:7}
  #warn.show{display:block}
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:var(--ui-pill);border:1px solid var(--ui-border);padding:6px 10px;border-radius:8px;opacity:0;transition:.2s;pointer-events: auto;font:12px monospace;z-index:7}
  #toast.show{opacity:1}

/* Pantalla de inicio mejorada */
#start {
  background: #0e0f13 !important;
  color: #e6ebef !important;
  font-family: system-ui, Segoe UI, Roboto, Arial !important;
}

#start h1 {
  color: #e6ebef !important;
  font-size: 48px !important;
  margin: 0 0 20px 0 !important;
  letter-spacing: 2px !important;
  text-shadow: none !important;
  font-weight: 700 !important;
}

#start > div {
  color: #e6ebef !important;
  opacity: 0.9 !important;
  font-size: 18px !important;
  margin-bottom: 30px !important;
}

#charSelect .char {
  background: #151515 !important;
  border: 1px solid #888 !important;
  color: #fff !important;
  font-family: system-ui, Segoe UI, Roboto, Arial !important;
  font-size: 18px !important;
  padding: 20px 24px !important;
  gap: 12px !important;
  border-radius: 8px !important;
  cursor: pointer !important;
}

#charSelect .char:hover {
  background: #252525 !important;
  border-color: #aaa !important;
}

#charSelect .char.selected {
  border: 2px solid #9fef00 !important;
  background: #1a1a1a !important;
  box-shadow: 0 0 10px rgba(159, 239, 0, 0.3) !important;
}

#charSelect canvas {
  border: 1px solid #444 !important;
  background: #111 !important;
}

#chosen {
  color: #e6ebef !important;
  font-size: 20px !important;
  margin-bottom: 20px !important;
  opacity: 0.9 !important;
}

#chosenName {
  color: #9fef00 !important;
  font-weight: bold !important;
}

#btnStart {
  background: #151515 !important;
  border: 1px solid #888 !important;
  color: #fff !important;
  font-family: system-ui, Segoe UI, Roboto, Arial !important;
  font-size: 18px !important;
  padding: 16px 32px !important;
  border-radius: 8px !important;
  cursor: pointer !important;
}

#btnStart:hover {
  background: #252525 !important;
}

#btnStart.ready {
  background: linear-gradient(135deg, #4CAF50, #45a049) !important;
  border-color: #4CAF50 !important;
  color: #fff !important;
  animation: pulse 2s infinite !important;
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); }
  100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
}

/* Reemplazar mejoras anteriores - Barra inferior completa estilo Diablo 2 */

/* Ocultar HUD original */
#topbar { display: none !important; }
#hud { display: none !important; }

/* Crear barra inferior completa */
#gameUI {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 100px;
  background: linear-gradient(to bottom, 
    rgba(0,0,0,0) 0%, 
    rgba(20,15,10,0.3) 20%, 
    rgba(40,30,20,0.8) 50%, 
    rgba(60,45,30,0.95) 100%);
  z-index: 1000;
  pointer-events: auto; /* ← IMPORTANTE: antes era none */
}

/* Orbe de vida (izquierda) */
#healthOrb {
  position: absolute;
  bottom: 10px;
  left: 20px;
  width: 80px;
  height: 80px;
  background: radial-gradient(circle at 30% 30%, 
    rgba(255,100,100,1) 0%, 
    rgba(200,50,50,1) 40%, 
    rgba(150,0,0,1) 80%, 
    rgba(100,0,0,1) 100%);
  border-radius: 50%;
  border: 3px solid #8b6914;
  box-shadow: 
    inset 0 0 20px rgba(0,0,0,0.5),
    0 0 15px rgba(139,105,20,0.6);
  overflow: hidden;
  cursor: pointer;
}

#healthOrbFill {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(to top,
    #cc2936 0%,
    #ff4444 30%,
    #ff6666 70%,
    #ffaaaa 100%);
  transition: height 0.3s ease;
  border-radius: 0 0 50px 50px;
}

#healthText {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-family: 'Segoe UI', sans-serif;
  font-size: 10px;
  font-weight: bold;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
  z-index: 2;
}

/* Orbe de maná (derecha) */
#manaOrb {
  position: absolute;
  bottom: 10px;
  right: 20px;
  width: 80px;
  height: 80px;
  background: radial-gradient(circle at 30% 30%, 
    rgba(100,150,255,1) 0%, 
    rgba(50,100,200,1) 40%, 
    rgba(0,50,150,1) 80%, 
    rgba(0,25,100,1) 100%);
  border-radius: 50%;
  border: 3px solid #8b6914;
  box-shadow: 
    inset 0 0 20px rgba(0,0,0,0.5),
    0 0 15px rgba(139,105,20,0.6);
  overflow: hidden;
  cursor: pointer;
}

#manaOrbFill {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(to top,
    #4169e1 0%,
    #6495ed 30%,
    #87ceeb 70%,
    #b0e0e6 100%);
  transition: height 0.3s ease;
  border-radius: 0 0 50px 50px;
}

#manaText {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  font-family: 'Segoe UI', sans-serif;
  font-size: 10px;
  font-weight: bold;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
  z-index: 2;
}

/* Panel central de habilidades */
#skillPanel {
  position: absolute;
  bottom: 15px;
  left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(135deg, 
    rgba(60,45,30,0.95) 0%, 
    rgba(40,30,20,0.9) 100%);
  border: 2px solid #8b6914;
  border-radius: 8px;
  padding: 8px 12px;
  display: flex;
  gap: 6px;
  align-items: center;
  box-shadow: 
    inset 0 1px 0 rgba(139,105,20,0.3),
    0 2px 8px rgba(0,0,0,0.6);
}

.skill-slot {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, 
    rgba(40,30,20,1) 0%, 
    rgba(20,15,10,1) 100%);
  border: 1px solid #8b6914;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
  pointer-events: auto;
}

.skill-slot:hover { border-color: #d4af37; box-shadow: 0 0 8px rgba(212,175,55,0.4); }

.skill-slot.active {
  background: linear-gradient(135deg, rgba(212,175,55,0.3) 0%, rgba(139,105,20,0.2) 100%);
  border-color: #d4af37;
  box-shadow: inset 0 0 8px rgba(212,175,55,0.3), 0 0 12px rgba(212,175,55,0.5);
}

.skill-icon { font-size: 16px; filter: drop-shadow(1px 1px 2px rgba(0,0,0,0.8)); }

.skill-key {
  position: absolute; top: -6px; right: -6px;
  background: #8b6914; color: #d4af37; font-size: 8px; font-weight: bold;
  width: 12px; height: 12px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center; border: 1px solid #d4af37;
}

.skill-level {
  position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
  background: #cc2936; color: white; font-size: 8px; font-weight: bold;
  padding: 1px 4px; border-radius: 8px; border: 1px solid #8b6914; min-width: 12px; text-align: center;
}

/* Info adicional en el panel */
#gameInfo {
  margin-left: 12px; padding-left: 12px; border-left: 1px solid #8b6914;
  color: #d4af37; font-family: 'Segoe UI', sans-serif; font-size: 9px;
}

.info-line { margin-bottom: 2px; display: flex; gap: 6px; }
.info-label { color: #c4a484; }
.info-value { color: #d4af37; font-weight: bold; }

.info-value.red { color: #ff4444; }
.info-value.green { color: #88ff88; }
.info-value.yellow { color: #ffdd44; }

/* Canvas ajustado para la nueva UI */
canvas {
  border: 3px solid #8b6914 !important;
  border-radius: 0 !important;
  box-shadow: inset 0 0 0 1px #d4af37, 0 4px 8px rgba(0, 0, 0, 0.6) !important;
  margin-bottom: 100px !important;
}

/* Toast mejorado */
#toast {
  background: linear-gradient(135deg, rgba(60,45,30,0.95) 0%, rgba(40,30,20,0.9) 100%) !important;
  border: 2px solid #8b6914 !important;
  color: #d4af37 !important;
  font-family: 'Segoe UI', sans-serif !important;
  font-size: 11px !important;
  font-weight: bold !important;
  box-shadow: inset 0 1px 0 rgba(139,105,20,0.3), 0 2px 8px rgba(0,0,0,0.6) !important;
  border-radius: 6px !important;
  padding: 8px 12px !important;
  bottom: 120px !important;
}

/* Responsive */
@media (max-width: 768px) {
  #gameUI { height: 80px; }
  #healthOrb, #manaOrb { width: 60px; height: 60px; bottom: 8px; }
  #healthOrb { left: 15px; }  #manaOrb { right: 15px; }
  #skillPanel { bottom: 12px; padding: 6px 8px; }
  .skill-slot { width: 28px; height: 28px; }
  .skill-icon { font-size: 14px; }
  #gameInfo { font-size: 8px; }
  canvas { margin-bottom: 80px !important; }
}

#healthOrb, #manaOrb, #skillPanel { pointer-events: auto; }
</style>
</head>
<body>
  <!-- TOP -->
  <div id="topbar">
    <div class="pill">WASD/←→↑↓ Move</div>
    <div class="pill">Click shoots — 1🔥 2⚡ 3❄ 4🌑</div>
    <div class="pill" id="spritesState">Sprites <span id="progress">loading…</span></div>
  </div>
  <div id="hud">
    <div>Map <span id="biome">1</span> · Life <span id="hp">100</span></div>
    <div>Kills <span id="kills">0</span>/50 · Boss <span id="boss">—</span></div>
    <div>Essence <span id="pts">0</span> · <span id="wname">Fire</span> Lv <span id="wlv">1</span></div>
  </div>

  <!-- VIEWPORT + CANVAS RESPONSIVE -->
  <div id="viewport"><canvas id="game" width="960" height="540"></canvas></div>

  <!-- OVERLAY Muerte / Info -->
  <div id="overlay">
    <div id="overlay-text" style="font-size:28px;letter-spacing:.5px;"></div>
    <div id="overlay-sub" style="opacity:.9;margin-top:6px;"></div>
    <button id="overlay-btn" class="btn">Continue</button>
  </div>

  <!-- START SCREEN: selección ANOMAGE / SHRIMP -->
  <div id="start" class="show">
    <h1 style="margin:0 0 6px 0;">ANOMA SURVIVAL</h1>
    <div style="opacity:.9;margin-bottom:10px">Choose your character and press <b>Play</b></div>

    <div id="charSelect" style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center;margin-bottom:10px">
      <button class="char btn" data-hero="anomage" style="display:flex;flex-direction:column;align-items:center;gap:6px">
        <span>ANOMAGE</span>
        <canvas id="prev-anomage" width="64" height="64" style="image-rendering:pixelated;border:1px solid #444;background:#111"></canvas>
      </button>
      <button class="char btn" data-hero="shrimp" style="display:flex;flex-direction:column;align-items:center;gap:6px">
        <span>SHRIMP</span>
        <canvas id="prev-shrimp" width="64" height="64" style="image-rendering:pixelated;border:1px solid #444;background:#111"></canvas>
      </button>
    </div>

    <div id="chosen" style="margin-bottom:6px;opacity:.9">Selected: <b id="chosenName">ANOMAGE</b></div>
    <button id="btnStart" class="btn">Play</button>
  </div>

  <!-- Sprites.json file loader (CORS en file://) -->
  <div id="warn" style="display:none !important;">
    <span>No se pudo cargar <b>assets/Sprites.json</b> (CORS en <code>file://</code>). Usando rutas por defecto.</span>
    <button id="btn-pick" class="btn" style="padding:6px 10px;margin-top:0">Cargar Sprites.json…</button>
    <input id="file-pick" type="file" accept="application/json" style="display:none"/>
  </div>
  <div id="toast"></div>

  <script src="game.js"></script>
  <script src="optimization.js"></script>

  <!-- Diablo 2 style bottom bar JS -->
  <script>
// JavaScript para crear la barra inferior estilo Diablo 2
// Añadir al final de tu index.html dentro de <script> tags

// Helpers para acceder al estado aunque no esté en window
function $GAME(){ try { return (typeof window!=='undefined' && window.GAME) || (typeof GAME!=='undefined' ? GAME : null); } catch(_) { return null; } }
function $BIOME(){ try { return (typeof window!=='undefined' && typeof window.BIOME!=='undefined') ? window.BIOME : (typeof BIOME!=='undefined' ? BIOME : 0); } catch(_) { return 0; } }
function $BOSS(){ try { return (typeof window!=='undefined' && typeof window.CURRENT_BOSS!=='undefined') ? window.CURRENT_BOSS : (typeof CURRENT_BOSS!=='undefined' ? CURRENT_BOSS : null); } catch(_) { return null; } }

// Crear la barra inferior cuando el juego inicie
function createDiablo2UI() {
  // Solo crear si no existe ya
  if (document.getElementById('gameUI')) return;
  
  // Crear contenedor principal
  const gameUI = document.createElement('div');
  gameUI.id = 'gameUI';
  document.body.appendChild(gameUI);
  
  // Crear orbe de vida
  const healthOrb = document.createElement('div');
  healthOrb.id = 'healthOrb';
  healthOrb.innerHTML = `
    <div id="healthOrbFill" style="height: 100%;"></div>
    <div id="healthText">100/100</div>
  `;
  gameUI.appendChild(healthOrb);
  
  // Crear orbe de maná
  const manaOrb = document.createElement('div');
  manaOrb.id = 'manaOrb';
  manaOrb.innerHTML = `
    <div id="manaOrbFill" style="height: 100%;"></div>
    <div id="manaText">50/50</div>
  `;
  gameUI.appendChild(manaOrb);
  
  // Crear panel de habilidades
  const skillPanel = document.createElement('div');
  skillPanel.id = 'skillPanel';
  skillPanel.innerHTML = `
    <div class="skill-slot active" data-skill="fire">
      <canvas class="skill-icon" width="24" height="24" data-spell="fire"></canvas>
      <div class="skill-key">1</div>
      <div class="skill-level" id="fireLevel">1</div>
    </div>
    <div class="skill-slot" data-skill="light">
      <canvas class="skill-icon" width="24" height="24" data-spell="light"></canvas>
      <div class="skill-key">2</div>
      <div class="skill-level" id="lightLevel">1</div>
    </div>
    <div class="skill-slot" data-skill="ice">
      <canvas class="skill-icon" width="24" height="24" data-spell="ice"></canvas>
      <div class="skill-key">3</div>
      <div class="skill-level" id="iceLevel">1</div>
    </div>
    <div class="skill-slot" data-skill="dark">
      <canvas class="skill-icon" width="24" height="24" data-spell="dark"></canvas>
      <div class="skill-key">4</div>
      <div class="skill-level" id="darkLevel">1</div>
    </div>
    <div id="gameInfo">
      <div class="info-line">
        <span class="info-label">Map:</span>
        <span class="info-value" id="mapValue">1</span>
      </div>
      <div class="info-line">
        <span class="info-label">Kills:</span>
        <span class="info-value" id="killsValue">0</span><span style="color:#666;">/50</span>
      </div>
      <div class="info-line">
        <span class="info-label">Boss:</span>
        <span class="info-value red" id="bossValue">—</span>
      </div>
      <div class="info-line">
        <span class="info-label">Essence:</span>
        <span class="info-value yellow" id="essenceValue">0</span>
      </div>
    </div>
  `;
  gameUI.appendChild(skillPanel);
  
  // Añadir eventos de clic a las habilidades
  document.querySelectorAll('.skill-slot').forEach(slot => {
    slot.addEventListener('click', () => {
      const skill = slot.dataset.skill;
      selectSkill(skill);
    });
  });
  
  console.log('UI Diablo 2 creada');
}

// Función para seleccionar habilidad
function selectSkill(skillType) {
  // Actualizar UI
  document.querySelectorAll('.skill-slot').forEach(slot => {
    slot.classList.remove('active');
  });
  
  const activeSlot = document.querySelector(`[data-skill="${skillType}"]`);
  if (activeSlot) {
    activeSlot.classList.add('active');
  }
  
  // Sincronizar con el juego original
  const G = $GAME();
  if (G) {
    G.weapon = skillType;
  }
}

// Función para actualizar los orbes
function updateDiablo2UI() {
  const G = $GAME();
  if (!G || !G.player) return;
  
  const player = G.player;
  
  // Actualizar orbe de vida
  const healthFill = document.getElementById('healthOrbFill');
  const healthText = document.getElementById('healthText');
  if (healthFill && healthText) {
    const healthPercent = Math.max(0, Math.min(100, (player.hp / player.hpMax) * 100));
    healthFill.style.height = `${healthPercent}%`;
    healthText.textContent = `${Math.round(player.hp)}/${player.hpMax}`;
  }
  
  // Actualizar orbe de maná
  const manaFill = document.getElementById('manaOrbFill');
  const manaText = document.getElementById('manaText');
  if (manaFill && manaText) {
    const manaPercent = Math.max(0, Math.min(100, (player.mana / player.manaMax) * 100));
    manaFill.style.height = `${manaPercent}%`;
    manaText.textContent = `${Math.round(player.mana)}/${player.manaMax}`;
  }
  
  // Actualizar info del juego
  const mapValue = document.getElementById('mapValue');
  const killsValue = document.getElementById('killsValue');
  const bossValue = document.getElementById('bossValue');
  const essenceValue = document.getElementById('essenceValue');
  
  if (mapValue) {
    mapValue.textContent = ($BIOME()|0) + 1;
  }
  
  if (killsValue && typeof G.killed !== 'undefined') {
    killsValue.textContent = G.killed;
  }
  
  const B = $BOSS();
  if (bossValue) {
    if (B) {
      bossValue.textContent = B.dead ? 'Dead' : 'Alive';
      bossValue.className = B.dead ? 'info-value green' : 'info-value red';
    } else {
      bossValue.textContent = '—';
      bossValue.className = 'info-value';
    }
  }
  
  if (essenceValue && typeof G.points !== 'undefined') {
    essenceValue.textContent = G.points;
  }
  
  // Actualizar niveles de habilidades
  ['fire', 'light', 'ice', 'dark'].forEach(skill => {
    const levelEl = document.getElementById(`${skill}Level`);
    if (levelEl && G.upgrades) {
      levelEl.textContent = G.upgrades[skill] || 1;
    }
  });
  
  // Sincronizar arma activa
  if (G.weapon) {
    const active = document.querySelector(`[data-skill="${G.weapon}"]`);
    if (active && !active.classList.contains('active')) {
      selectSkill(G.weapon);
    }
  }
}

// Escuchar teclas para cambiar habilidades
document.addEventListener('keydown', (e) => {
  const keyMap = { '1': 'fire', '2': 'light', '3': 'ice', '4': 'dark' };
  const G = $GAME();
  if (keyMap[e.key] && G && G.running) {
    selectSkill(keyMap[e.key]);
  }
});

// ----- Inicialización robusta -----
let uiCreated = false;
function ensureUI(){
  if(!document.getElementById('gameUI')){
    createDiablo2UI();
    uiCreated = true;
  }
}

// 1) Crear al cargar DOM / ventana
document.addEventListener('DOMContentLoaded', ensureUI);
window.addEventListener('load', ensureUI);
// 2) Hook al botón Play
const _btnStart = document.getElementById('btnStart');
if (_btnStart) {
  _btnStart.addEventListener('click', () => {
    ensureUI();
    setTimeout(ensureUI, 300);
  });
}
// 3) Observar pantalla de inicio
const startEl = document.getElementById('start');
if (startEl) {
  const obs = new MutationObserver(() => {
    if (!startEl.classList.contains('show')) ensureUI();
  });
  obs.observe(startEl, { attributes: true, attributeFilter: ['class'] });
}
// 4) Bucle de actualización
setInterval(() => {
  if (!uiCreated) ensureUI();
  const G = $GAME();                 // ← usar helper, no window.GAME
  if (G && G.player) updateDiablo2UI();
}, 100);
// 5) Helpers globales
window.FORCE_DIABLO_UI = ensureUI;
window.UPDATE_DIABLO_UI = updateDiablo2UI;

// AÑADIR ESTA FUNCIÓN AQUÍ:
function drawSpellIcons() {
  const spells = {
    fire: 'assets/Sprites/image_spells/fireball_1.png',
    light: 'assets/Sprites/image_spells/lightning_1.png', 
    ice: 'assets/Sprites/image_spells/ice_shard_1.png',
    dark: 'assets/Sprites/image_spells/dark_blast_1.png'
  };
  
  Object.keys(spells).forEach(spell => {
    const canvas = document.querySelector(`canvas[data-spell="${spell}"]`);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled = false;
    
    const img = new Image();
    img.onload = () => {
      ctx.clearRect(0, 0, 24, 24);
      ctx.drawImage(img, 0, 0, 24, 24);
    };
    img.src = spells[spell];
  });
}

  </script>
</body>
</html>

